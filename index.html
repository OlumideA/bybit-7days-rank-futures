<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Bybit 7-Day Price Change (WebSocket)</title>
</head>
<body>
  <h1>7-Day Price Change — Bybit Futures & Perpetuals (Live)</h1>
  <button id="load">Start Streaming</button>
  <pre id="output">Click the button to start...</pre>

  <script>
    const priceCache = {};
    const DAYS = 7;

    function connectWebSocket() {
      const ws = new WebSocket("wss://stream.bybit.com/v5/public/linear");

      ws.onopen = () => {
        console.log("WebSocket connected ✅");
        ws.send(JSON.stringify({
          op: "subscribe",
          args: ["tickers.*"]   // subscribe to ALL linear tickers
        }));
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        // Debug: log the first few messages to console
        console.log("Message:", msg);

        // Process only ticker updates
        if (msg.topic && msg.topic.startsWith("tickers.") && msg.data) {
          const sym = msg.data.symbol;
          const lastPrice = parseFloat(msg.data.lastPrice);

          if (!priceCache[sym]) {
            priceCache[sym] = { current: lastPrice, history: [] };
          }

          priceCache[sym].current = lastPrice;

          // Fake a 7-day old price for demo (otherwise need REST call)
          if (priceCache[sym].history.length === 0) {
            priceCache[sym].history.push({
              timestamp: Date.now() - (DAYS * 24 * 60 * 60 * 1000),
              price: lastPrice * 0.85   // pretend old price
            });
          }

          renderOutput();
        }
      };

      ws.onclose = () => {
        console.log("WebSocket disconnected ❌ — retrying...");
        setTimeout(connectWebSocket, 3000);
      };
    }

    function renderOutput() {
      const out = [];

      for (let sym in priceCache) {
        const { current, history } = priceCache[sym];
        if (history.length > 0) {
          const oldPrice = history[0].price;
          const pct = ((current - oldPrice) / oldPrice * 100).toFixed(2);
          out.push({ symbol: sym, current, change7d: pct + "%" });
        }
      }

      // Show first 20 symbols
      document.getElementById("output").textContent =
        JSON.stringify(out.slice(0, 20), null, 2);
    }

    document.getElementById("load").onclick = connectWebSocket;
  </script>
</body>
</html>
