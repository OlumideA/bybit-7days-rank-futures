<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Bybit 7-Day Price Change (WebSocket)</title>
</head>
<body>
  <h1>7-Day Price Change — Bybit Futures & Perpetuals (Live)</h1>
  <button id="load">Start Streaming</button>
  <pre id="output"></pre>

  <script>
    // Store prices
    const priceCache = {};   // { symbol: { current: 0, history: [] } }
    const DAYS = 7;

    function connectWebSocket() {
      const ws = new WebSocket("wss://stream.bybit.com/v5/public/linear");

      ws.onopen = () => {
        console.log("WebSocket connected ✅");
        // Subscribe to ALL linear tickers (perpetual USDT contracts)
        ws.send(JSON.stringify({
          op: "subscribe",
          args: ["tickers.*"]   // * = all tickers
        }));
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        // Only process ticker updates
        if (msg.topic && msg.topic.startsWith("tickers.")) {
          const sym = msg.topic.split(".")[1];
          const lastPrice = parseFloat(msg.data.lastPrice);

          if (!priceCache[sym]) {
            priceCache[sym] = { current: lastPrice, history: [] };
          }

          // Update current price
          priceCache[sym].current = lastPrice;

          // For demo, simulate "7-day history" by storing price snapshots
          // In production, you'd store actual daily closes from DB
          if (priceCache[sym].history.length === 0) {
            priceCache[sym].history.push({
              timestamp: Date.now() - (DAYS * 24 * 60 * 60 * 1000),
              price: lastPrice * 0.85  // fake a 7d-old price for testing
            });
          }

          renderOutput();
        }
      };

      ws.onclose = () => {
        console.log("WebSocket disconnected ❌ — retrying...");
        setTimeout(connectWebSocket, 3000);
      };
    }

    function renderOutput() {
      const out = [];

      for (let sym in priceCache) {
        const { current, history } = priceCache[sym];
        if (history.length > 0) {
          const oldPrice = history[0].price;
          const pct = ((current - oldPrice) / oldPrice * 100).toFixed(2);
          out.push({ symbol: sym, current, change7d: pct + "%" });
        }
      }

      document.getElementById("output").textContent =
        JSON.stringify(out.slice(0, 20), null, 2); // show top 20
    }

    document.getElementById("load").onclick = connectWebSocket;
  </script>
</body>
</html>
